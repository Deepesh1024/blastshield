name: BlastShield Main Branch Scan

on:
  push:
    branches: [main]

jobs:
  blastshield-main-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for diff

      - name: Get changed code files
        id: changed
        run: |
          # Get files changed in this push (compared to previous commit)
          CHANGED=$(git diff --name-only HEAD~1 HEAD | \
            grep -E '\.(py|js|ts|jsx|tsx|java|go|sol|cpp|c|rs)$' | \
            grep -vE '(node_modules|venv|dist|build|__pycache__|\.git)/' || true)

          if [ -z "$CHANGED" ]; then
            echo "No code files changed."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Changed files:"
          echo "$CHANGED"

          # Build JSON payload with only changed files
          python3 -c "
          import json

          files = []
          for line in '''$CHANGED'''.strip().split('\n'):
              path = line.strip()
              if not path:
                  continue
              try:
                  with open(path, 'r', errors='ignore') as f:
                      content = f.read()
                  files.append({'path': path, 'content': content})
              except FileNotFoundError:
                  pass

          with open('payload.json', 'w') as out:
              json.dump({'files': files}, out)

          print(f'Collected {len(files)} changed files for scanning.')
          "

      - name: Scan with BlastShield
        if: steps.changed.outputs.skip != 'true'
        run: |
          RESPONSE=$(curl -s -X POST \
            "${{ secrets.BLASTSHIELD_API_URL }}/pr-scan" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            --max-time 120)

          echo "$RESPONSE" > scan_result.json

      - name: Create GitHub Issue if critical issues found
        if: steps.changed.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let result;
            try {
              result = JSON.parse(fs.readFileSync('scan_result.json', 'utf8'));
            } catch {
              console.log('No scan results.');
              return;
            }

            if (result.message !== 'scan_complete') {
              console.log('Scan did not complete:', result.message);
              return;
            }

            const report = result.report;
            const issues = report.issues || [];
            const riskScore = report.riskScore || 0;

            // Only create an issue if critical or high severity issues exist
            const critical = issues.filter(i => i.severity === 'critical');
            const high = issues.filter(i => i.severity === 'high');

            if (critical.length === 0 && high.length === 0) {
              console.log('No critical/high issues. Skipping issue creation.');
              return;
            }

            const commitSha = context.sha.substring(0, 7);
            const pusher = context.actor;

            // Build issue body
            let body = `## ğŸ›¡ï¸ BlastShield Alert â€” Critical Issues on \`main\`\n\n`;
            body += `**Commit:** \`${commitSha}\` by @${pusher}\n`;
            body += `**Risk Score:** ${riskScore >= 70 ? 'ğŸ”´' : 'ğŸŸ¡'} **${riskScore}/100**\n`;
            body += `**Critical:** ${critical.length} Â· **High:** ${high.length}\n\n`;
            body += `---\n\n`;

            const dangerousIssues = [...critical, ...high];

            for (const issue of dangerousIssues) {
              const icon = issue.severity === 'critical' ? 'ğŸ”´' : 'ğŸŸ ';
              body += `### ${icon} ${issue.severity.toUpperCase()}: ${issue.issue}\n`;
              body += `ğŸ“ \`${issue.file}\`\n\n`;
              body += `**Problem:** ${issue.explanation}\n\n`;
              body += `**Risk:** ${issue.risk}\n\n`;

              if (issue.patches && issue.patches.length > 0) {
                const patch = issue.patches[0];
                body += `<details>\n<summary>ğŸ’¡ Suggested Fix (Lines ${patch.start_line}â€“${patch.end_line})</summary>\n\n`;
                body += `\`\`\`\n${patch.new_code}\n\`\`\`\n`;
                body += `</details>\n\n`;
              }

              body += `---\n\n`;
            }

            body += `<sub>ğŸ›¡ï¸ Auto-generated by BlastShield â€” AI Deployment Safety</sub>`;

            // Create the GitHub issue
            const title = `ğŸ›¡ï¸ BlastShield: ${critical.length} Critical, ${high.length} High issues found on main (${commitSha})`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['blastshield', 'security', 'bug']
            });

            console.log(`Created GitHub issue for ${dangerousIssues.length} critical/high issues.`);

      - name: No code changes
        if: steps.changed.outputs.skip == 'true'
        run: echo "No code files changed in this push. Skipping scan."
